<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eleview V1.2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
html, body { min-height:100%; margin:0; padding:0; font-family:"Inter","Noto Sans KR",sans-serif; color:#fff; overflow-x:hidden; transition: background 0.3s;}
#particle-wrap { position:fixed; inset:0; width:100%; height:100%; z-index:0; pointer-events:none; }
.app { position:relative; z-index:2; max-width:480px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:12px; min-height:100vh; }
header{text-align:center; margin-top:5vh; position:relative;}
.logo{font-size:20px; font-weight:700; color:#fff; padding:10px 14px; border-radius:12px; background:rgba(255,255,255,0.05); box-shadow:0 0 20px rgba(155,92,255,0.25);}
.subtitle{text-align:center; color:rgba(255,255,255,0.75); font-size:13px;}
#visitorCount{font-size:12px; color:#ccc; margin-top:4px;}
.search{display:flex; flex-direction:column; gap:8px;}
.box{width:95%; background:rgba(255,255,255,0.05); border-radius:10px; padding:6px 8px; display:flex; align-items:center; backdrop-filter:blur(6px);}
input[type=text]{flex:1; background:transparent; border:none; outline:none; color:#fff; font-size:14px; padding:6px;}
.btn{background:linear-gradient(180deg,#9b5cff 0%,#6e22ff 100%); border:none; color:#fff; padding:10px; border-radius:10px; font-weight:600; cursor:pointer; width:100%;}
#result-list{margin-top:16px; display:flex; flex-direction:column; gap:12px; padding-bottom:60px;}
.card{background:rgba(255,255,255,0.06); border-radius:12px; padding:12px; box-shadow:0 4px 16px rgba(0,0,0,0.4); backdrop-filter:blur(10px);}
#customBtn { position: absolute; top: 10px; right: 10px; padding: 8px 14px; border-radius: 12px; font-weight: 600; font-size: 14px; background:none; border:2px solid #d67cff; color: #d67cff; cursor: pointer; box-shadow:none; transition: all 0.3s ease; text-shadow: 0 0 6px rgba(255,255,255,0.3);}
#customBtn:hover { transform: translateY(-2px); box-shadow: 0 0 12px rgba(155,92,255,0.7); }
#customModal, #historyModal{display:none; position:fixed; inset:0; justify-content:center; align-items:center; z-index:10;}
#customModal{background:rgba(0,0,0,0.7);}
#customContent, #historyContentBox{background:rgba(0,0,0,1); padding:20px; border-radius:12px; display:flex; flex-direction:column; gap:10px;}
#customContent label{font-size:13px;}
#customContent input, #customContent button{margin-top:5px;}
#historyContentBox{max-width:400px; width:100%; color:#fff; max-height:70vh; overflow:auto;}
.footer{text-align:center; color:rgba(255,255,255,0.5); font-size:11px; margin:20px 0;}
</style>
</head>
<body style="background:#000000;">

<canvas id="particle-wrap"></canvas>

<div class="app">
<header style="display:flex; justify-content:center; align-items:center; position:relative; margin-top:5vh;">
   <a href="https://open.kakao.com/o/sYLH7W1h" target="_blank"
     style="position:absolute; left:10px; top:50%; transform:translateY(-50%);
            padding:8px 14px; border-radius:12px; font-weight:600; font-size:13px;
            background:none; border:2px solid #9b5cff; color:#9b5cff; cursor:pointer; 
            text-decoration:none; text-shadow:0 0 6px rgba(255,255,255,0.25);
            transition: all 0.3s ease;">
    ğŸ“© ë¬¸ì˜
  </a>
  <div class="logo">Eleview V1.2</div>
  <button id="customBtn" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);">âš™ï¸ ì„¤ì •</button>
</header>
<div class="subtitle">
  ìŠ¹ê°•ê¸° ì •ë³´ ì¡°íšŒ
  <div id="visitorCount">ì ‘ì†ì: 0ëª…</div>
</div>

<div class="search">
  <div class="box"><input id="elevatorNo" type="text" placeholder="ìŠ¹ê°•ê¸° ë²ˆí˜¸ ì…ë ¥"></div>
  <div class="box"><input id="buldAddress" type="text" placeholder="ê±´ë¬¼ì£¼ì†Œ ì…ë ¥"></div>
  <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
</div>

<div id="result-list"></div>

<div id="customModal">
  <div id="customContent">
    <h3>ì»¤ìŠ¤í„°ë§ˆì´ì§•</h3>
    <label>ë°°ê²½ ì´ë¯¸ì§€ ì„ íƒ: <input type="file" id="bgImage" accept="image/*"></label>
    <label>ë°°ê²½ ìƒ‰ìƒ (ì´ë¯¸ì§€ ì—†ì„ ë•Œ): <input type="color" id="bgColor" value="#1a002e"></label>
    <label>íŒŒí‹°í´ ìƒ‰ìƒ: <input type="color" id="particleColor" value="#9b5cff"></label>
    <label>íŒŒí‹°í´ ìˆ˜ëŸ‰: <input type="number" id="particleCount" value="80" min="10" max="300"></label>
    <label>ê²€ìƒ‰ ë²„íŠ¼ í…ìŠ¤íŠ¸: <input type="text" id="searchText" value="ê²€ìƒ‰"></label>
    <label>ê²€ìƒ‰ ë²„íŠ¼ ìƒ‰ìƒ: <input type="color" id="searchColor" value="#9b5cff"></label>
    <button class="btn" id="applyBtn">ì ìš©</button>
    <button class="btn" id="closeModal">ë‹«ê¸°</button>
  </div>
</div>

<div id="historyModal">
  <div id="historyContentBox">
    <button id="closeHistoryBtn" class="btn" style="align-self:flex-end; margin-bottom:10px;">ë‹«ê¸°</button>
    <h3>ê²€ì‚¬ì´ë ¥</h3>
    <div id="historyContent"></div>
  </div>
</div>

<div class="footer" style="display:flex; flex-direction:column; align-items:center; gap:6px;">
  @2025 Eleview V1.2 - ì œì‘ì : ë§ˆë…€
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ==== Firebase ì‹¤ì‹œê°„ ë™ì ‘ì (TTL ë°©ì‹) ====
  const firebaseConfig = {
    apiKey: "AIzaSyApdyHj-1DiEsOG7XZ6zmDLIEwtLJZ70Js",
    authDomain: "elev-5374e.firebaseapp.com",
    databaseURL: "https://elev-5374e-default-rtdb.firebaseio.com",
    projectId: "elev-5374e",
    storageBucket: "elev-5374e.firebasestorage.app",
    messagingSenderId: "265381396625",
    appId: "1:265381396625:web:5a3db379ef4a038ee43f30",
    measurementId: "G-6XPKDKFE9V"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const visitorRef = db.ref('visitors');
  const visitorId = Date.now() + '_' + Math.floor(Math.random() * 1000);

  // ì²˜ìŒ ì ‘ì† ì‹œ ê¸°ë¡
  function updateVisitor(){
    visitorRef.child(visitorId).set({ lastActive: Date.now() });
  }
  updateVisitor();

  // 5ì´ˆë§ˆë‹¤ ê°±ì‹ 
  setInterval(updateVisitor, 5000);

  // ì‹¤ì‹œê°„ ë™ì ‘ì í‘œì‹œ
  visitorRef.on('value', snapshot => {
    const now = Date.now();
    let count = 0;
    snapshot.forEach(child => {
      if(now - child.val().lastActive < 15000) count++; // 15ì´ˆ ì´ìƒ í™œë™ ì—†ìœ¼ë©´ ì œì™¸
    });
    document.getElementById('visitorCount').textContent = `ì ‘ì†ì: ${count}ëª…`;
  });

// ==== ê¸°ë³¸ ë³€ìˆ˜ ====
const inputNo = document.getElementById('elevatorNo');
const inputAddr = document.getElementById('buldAddress');
const btn = document.getElementById('searchBtn');
const list = document.getElementById('result-list');
let visitorCount = 0;
let remainingTraffic = 10000;
let searchLogs = [];

// ==== API ====
const serviceKey = '6a8c61a1b9e03198dc42d9460e8bf434e703bc3d0989512930046a21a68e1432';
const API_OPERATION = 'https://apis.data.go.kr/B553664/ElevatorOperationService/getOperationInfoListV1';
const API_VIEW = 'https://apis.data.go.kr/B553664/ElevatorInformationService/getElevatorViewM';
const API_HISTORY = 'https://apis.data.go.kr/B553664/ElevatorInformationService/getElvtrInspctInqireM';

function getElevatorIcon(type){
  if(!type) return ['https://img.icons8.com/ios-filled/50/ffffff/help.png'];
  type=type.trim(); let icons=[];
  if(type.includes('ìŠ¹ê°')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/elevator.png');
  if(type.includes('ì „ë§')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/mountain.png');
  if(type.includes('ë³‘ì›')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/hospital.png');
  if(type.includes('ì¥ì• ì¸')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/wheelchair.png');
  if(type.includes('ì†Œë°©êµ¬ì¡°')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/fire-truck.png');
  if(type.includes('í”¼ë‚œ')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/exit.png');
  if(type.includes('ì£¼íƒ')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/home.png');
  if(type.includes('í™”ë¬¼')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/package.png');
  if(type.includes('ìë™ì°¨')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/car.png');
  if(type.includes('ì†Œí˜•í™”ë¬¼')) icons.push('https://img.icons8.com/ios-filled/50/ffffff/small-package.png');
  return icons.length?icons:['https://img.icons8.com/ios-filled/50/ffffff/help.png'];
}

// ==== ê²€ìƒ‰ ë²„íŠ¼ ====
btn.addEventListener('click', async () => {
    const query = inputNo.value.trim();
    visitorCount++;
    if(!query && !inputAddr.value.trim()){
        list.innerHTML = '<p>ìŠ¹ê°•ê¸° ë²ˆí˜¸ ë˜ëŠ” ê±´ë¬¼ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
        return;
    }

    searchLogs.push(`${query || inputAddr.value.trim()} ê²€ìƒ‰ - ${new Date().toLocaleString()}`);
    remainingTraffic--;

    const params = new URLSearchParams({ serviceKey, pageNo:'1', numOfRows:'50' });
    if(query) params.append('elevator_no', query);
    if(inputAddr.value.trim()) params.append('buld_address', inputAddr.value.trim());

    list.innerHTML = '';
    try{
        const res = await fetch(`${API_OPERATION}?${params}`);
        const xmlText = await res.text();
        const xml = new DOMParser().parseFromString(xmlText, "text/xml");
        const items = Array.from(xml.getElementsByTagName("item"));

        if(items.length === 0){ list.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }

        for(const item of items){
            const get=(t)=>item.getElementsByTagName(t)[0]?.textContent||'';
            const elevatorNo = get("elevatorNo");
            const kind = get("elvtrKindNm");
            const icons = getElevatorIcon(kind);

            const viewUrl = `${API_VIEW}?serviceKey=${serviceKey}&elevator_no=${elevatorNo}`;
            const viewRes = await fetch(viewUrl);
            const viewXml = await viewRes.text();
            const viewDoc = new DOMParser().parseFromString(viewXml, "text/xml");
            const viewItem = viewDoc.getElementsByTagName("item")[0];
            const v = (t)=>viewItem?.getElementsByTagName(t)[0]?.textContent||'';

            const historyUrl = `${API_HISTORY}?serviceKey=${serviceKey}&elevator_no=${elevatorNo}`;
            const hisRes = await fetch(historyUrl);
            const hisXml = await hisRes.text();
            const hisDoc = new DOMParser().parseFromString(hisXml,"text/xml");
            const historyItems = Array.from(hisDoc.getElementsByTagName("item"));

            const shuttleFloor = get("shuttleFloorCnt") || v("shuttleFloorCnt") || 'N/A';
            const speed = get("ratedSpeed") || v("ratedSpeed");
            const speedMMin = speed ? (parseFloat(speed)*60).toFixed(1) : 'N/A';
            const liveLoad = get("liveLoad") || v("liveLoad");
            const liveLoadDisplay = liveLoad ? `${liveLoad} kg` : 'N/A';

            const div = document.createElement('div');
            div.className='card';
            div.innerHTML=`
                <h3>${get("buldNm")||v("buldNm")}</h3>
                <div class='meta'>${elevatorNo} â€¢ ${get("elvtrDiv")}</div>
                <div class='info'>
                <strong>ì£¼ì†Œ1/2:</strong> ${get("address1")} / ${get("address2")}<br>
                <strong>ì‹œë„/ì‹œêµ°êµ¬:</strong> ${get("sido")} / ${get("sigungu")}<br>
                <strong>ìŠ¹ê°•ê¸°í˜¸ê¸°:</strong> ${get("elvtrAsignNo")}<br>
                <strong>ìŠ¹ê°•ê¸°í˜•ì‹/ì„¸ë¶€í˜•ì‹:</strong> ${get("elvtrForm")} / ${get("elvtrDetailForm")}<br>
                <strong>ëª¨ë¸ëª…:</strong> ${get("elvtrModel")}<br>
                <strong>ìŠ¹ê°•ê¸°ì¢…ë¥˜:</strong> ${kind} ${icons.map(i=>`<img src="${i}" style="width:24px;height:24px;margin-right:4px;">`).join('')}<br>
                <strong>ì„¤ì¹˜ì¼ì:</strong> ìµœì´ˆ: ${get("frstInstallationDe")} / ìµœê·¼: ${get("installationDe")}<br>
                <strong>ì„¤ì¹˜ì¥ì†Œ:</strong> ${get("installationPlace")}<br>
                <strong>ìš´í–‰ì¸µìˆ˜:</strong> ${shuttleFloor}ì¸µ<br>
                <strong>ì •ê²©ì†ë„:</strong> ${speedMMin} m/min<br>
                <strong>ì ì¬í•˜ì¤‘:</strong> ${liveLoadDisplay}<br>
                <strong>ìµœëŒ€ì •ì›:</strong> ${get("ratedCap")}<br>
                <strong>ì œì¡°ì‚¬:</strong> ${get("mnfcturCpnyNm")} / ${get("companyNm")}<br>
                <strong>ìœ íš¨ê¸°ê°„:</strong> ${get("applcBeDt")} ~ ${get("applcEnDt")}<br>
                <strong>ê´€ë¦¬ê¸°ê´€:</strong> ${get("inspctInsttNm")}<br>
                <strong>ìŠ¹ê°•ê¸°ìƒíƒœ:</strong> ${get("elvtrSttsNm")}<br>
                <button class="btn view-history-btn" data-history='${encodeURIComponent(JSON.stringify(historyItems.map(h=>{
                    const hget=(t)=>h.getElementsByTagName(t)[0]?.textContent||'';
                    return { inspctDt:hget("inspctDt"), inspctInsttNm:hget("inspctInsttNm"), inspctKind:hget("inspctKind"), psexamYn:hget("psexamYn") };
                })))}'>ğŸ“Œ ê²€ì‚¬ì´ë ¥ ë³´ê¸°</button>
                </div>`;
            list.appendChild(div);
        }
    }catch(e){ list.innerHTML = `<p>ì˜¤ë¥˜: ${e.message}</p>`; }
});

// ==== ê²€ì‚¬ì´ë ¥ ëª¨ë‹¬ ==== 
document.addEventListener('click', e => {
  if(e.target.classList.contains('view-history-btn')){
    const data = JSON.parse(decodeURIComponent(e.target.dataset.history));
    const content = document.getElementById('historyContent');
    content.innerHTML = data.map(h => {
      const exam = h.psexamYn; // í•©ê²© ì—¬ë¶€ ë¬¸ìì—´
      let bgColor = 'rgba(255,255,255,0.05)'; // ê¸°ë³¸ìƒ‰
      if(exam.includes('ë¶ˆí•©ê²©')) bgColor = 'rgba(255,0,0,0.4)';        // ë¹¨ê°•
      else if(exam.includes('ì¡°ê±´ë¶€í•©ê²©')) bgColor = 'rgba(255,255,0,0.4)'; // ë…¸ë‘
      else if(exam.includes('í•©ê²©')) bgColor = 'rgba(0,255,0,0.3)';      // ì´ˆë¡
      else if(exam.includes('ë³´ì™„') || exam.includes('ì°¨ê¸°ì•ˆì „ê²€ì‚¬')) bgColor = 'rgba(255,165,0,0.4)'; // ì£¼í™©

      return `<div style="margin:4px 0; padding:6px; background:${bgColor}; border-radius:6px;">
          <strong>ê²€ì‚¬ì¼ì:</strong> ${h.inspctDt}<br>
          <strong>ê²€ì‚¬ê¸°ê´€:</strong> ${h.inspctInsttNm}<br>
          <strong>ê²€ì‚¬ì¢…ë¥˜:</strong> ${h.inspctKind}<br>
          <strong>í•©ê²©ì—¬ë¶€:</strong> ${h.psexamYn}
      </div>`;
    }).join('');
    document.getElementById('historyModal').style.display = 'flex';
  }
});
document.getElementById('closeHistoryBtn').addEventListener('click',()=>{document.getElementById('historyModal').style.display='none';});

// ==== íŒŒí‹°í´ ====
const c=document.getElementById('particle-wrap'); const ctx=c.getContext('2d'); let w,h;
function resize(){ w=c.width=innerWidth; h=c.height=innerHeight; } addEventListener('resize',resize); resize();
let p=[]; function initParticles(count=80,color='#9b5cff'){ p.length=0; for(let i=0;i<count;i++) p.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,s:Math.random()*2+1,color:color}); }
function draw(){ ctx.clearRect(0,0,w,h); for(const a of p){ a.x+=a.vx; a.y+=a.vy; if(a.x<0)a.x=w;if(a.x>w)a.x=0;if(a.y<0)a.y=h;if(a.y>h)a.y=0; const g=ctx.createRadialGradient(a.x,a.y,0,a.x,a.y,10); g.addColorStop(0,a.color); g.addColorStop(1,'transparent'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(a.x,a.y,a.s,0,Math.PI*2); ctx.fill(); } requestAnimationFrame(draw);}
draw();

// ==== ì»¤ìŠ¤í„°ë§ˆì´ì§• ëª¨ë‹¬ ====
const customBtn=document.getElementById('customBtn');
const customModal=document.getElementById('customModal');
const closeModal=document.getElementById('closeModal');
const applyBtn=document.getElementById('applyBtn');
const bgImageInput=document.getElementById('bgImage');
const bgColorInput=document.getElementById('bgColor');
const particleColorInput=document.getElementById('particleColor');
const particleCountInput=document.getElementById('particleCount');
const searchTextInput=document.getElementById('searchText');
const searchColorInput=document.getElementById('searchColor');

customBtn.addEventListener('click',()=>customModal.style.display='flex');
closeModal.addEventListener('click',()=>customModal.style.display='none');

// ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸°
window.addEventListener('load',()=>{
    const bgColor = localStorage.getItem('bgColor');
    const particleColor = localStorage.getItem('particleColor');
    const particleCount = localStorage.getItem('particleCount');
    const searchText = localStorage.getItem('searchText');
    const searchColor = localStorage.getItem('searchColor');
    const bgImage = localStorage.getItem('bgImage');

    if(bgImage) document.body.style.background = `url(${bgImage}) center/cover no-repeat`;
    else if(bgColor) document.body.style.background = bgColor;

    initParticles(particleCount ? parseInt(particleCount) : 80, particleColor || '#9b5cff');

    if(searchText) btn.textContent = searchText;
    if(searchColor) btn.style.background = `linear-gradient(180deg, ${searchColor} 0%, ${searchColor} 100%)`;
});

// ì ìš© ì‹œ ì €ì¥
applyBtn.addEventListener('click', ()=>{
    const file = bgImageInput.files[0];
    const color = bgColorInput.value;
    if(file){
        const reader = new FileReader();
        reader.onload = function(e){
            document.body.style.background = `url(${e.target.result}) center/cover no-repeat`;
            localStorage.setItem('bgImage', e.target.result);
        };
        reader.readAsDataURL(file);
        localStorage.setItem('bgColor', color);
    } else {
        document.body.style.background = color;
        localStorage.setItem('bgColor', color);
        localStorage.removeItem('bgImage');
    }

    const pCount = parseInt(particleCountInput.value);
    const pColor = particleColorInput.value;
    initParticles(pCount, pColor);
    localStorage.setItem('particleCount', pCount);
    localStorage.setItem('particleColor', pColor);

    const sText = searchTextInput.value;
    const sColor = searchColorInput.value;
    btn.textContent = sText;
    btn.style.background = `background:#000000;`;
    localStorage.setItem('searchText', sText);
    localStorage.setItem('searchColor', sColor);

    customModal.style.display = 'none';
});
</script>
</body>
</html>
