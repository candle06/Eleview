<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Eleview ê´€ë¦¬ì í˜ì´ì§€</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; background:#0d0d0d; color:white; padding:20px; }
  h1 { text-align:center; margin-bottom:20px; }
  .card { background:#1a1a1a; padding:20px; border-radius:12px; margin-bottom:20px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { padding:8px; border-bottom:1px solid #333; }
  th { background:#222; }
</style>
</head>
<body>

<h1>ğŸ“Š Eleview ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>

<div id="authCheck" class="card">
  ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...
</div>

<div id="adminContent" style="display:none;">

  <div class="card">
    <h2>ì˜¤ëŠ˜ ê²€ìƒ‰ëœ íšŸìˆ˜</h2>
    <p id="todayCount">0 íšŒ</p>
  </div>

  <div class="card">
    <h2>ìµœê·¼ ê²€ìƒ‰ 50ê°œ</h2>
    <table>
      <thead>
        <tr><th>ì‹œê°„</th><th>ê²€ìƒ‰ì–´</th><th>ì¢…ë¥˜</th></tr>
      </thead>
      <tbody id="logTable"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>ê²€ìƒ‰ ì¢…ë¥˜ ë¹„ìœ¨</h2>
    <canvas id="typeChart"></canvas>
  </div>

  <div class="card">
    <h2>ê°€ì¥ ë§ì´ ê²€ìƒ‰ëœ ìŠ¹ë²ˆ TOP 10</h2>
    <ul id="topList"></ul>
  </div>

</div>

<script>
// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyApdyHj-1DiEsOG7XZ6zmDLIEwtLJZ70Js",
  authDomain: "elev-5374e.firebaseapp.com",
  databaseURL: "https://elev-5374e-default-rtdb.firebaseio.com",
  projectId: "elev-5374e",
  storageBucket: "elev-5374e.firebasestorage.app",
  messagingSenderId: "265381396625",
  appId: "1:265381396625:web:5a3db379ef4a038ee43f30",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ===== ê´€ë¦¬ì ì¸ì¦ =====
const ADMIN_EMAIL = "candle0627@gmail.com";

auth.onAuthStateChanged(user => {
  if (!user) {
    document.getElementById("authCheck").innerHTML = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    return;
  }

  if (user.email !== ADMIN_EMAIL) {
    document.getElementById("authCheck").innerHTML = "ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  document.getElementById("authCheck").style.display = "none";
  document.getElementById("adminContent").style.display = "block";

  loadDashboard();
});

// ===== ëŒ€ì‹œë³´ë“œ ë¡œë“œ =====
function loadDashboard() {
  db.ref("searchLogs").limitToLast(500).once("value", snap => {
    const data = [];
    snap.forEach(s => data.push(s.val()));

    data.reverse(); // ìµœì‹ ìˆœ

    renderTodayCount(data);
    renderLogTable(data);
    renderTypeChart(data);
    renderTopList(data);
  });
}

// ì˜¤ëŠ˜ ê²€ìƒ‰ëœ ìˆ˜
function renderTodayCount(data) {
  const today = new Date().toISOString().split("T")[0];
  const count = data.filter(d => new Date(d.timestamp).toISOString().startsWith(today)).length;
  document.getElementById("todayCount").textContent = count + " íšŒ";
}

// ìµœê·¼ ê²€ìƒ‰ 50ê°œ í…Œì´ë¸”
function renderLogTable(data) {
  const tbody = document.getElementById("logTable");
  const rows = data.slice(0, 50).map(d => `
    <tr>
      <td>${new Date(d.timestamp).toLocaleString()}</td>
      <td>${d.query}</td>
      <td>${d.type}</td>
    </tr>
  `).join("");
  tbody.innerHTML = rows;
}

// ê²€ìƒ‰ ì¢…ë¥˜ ë¹„ìœ¨ ì°¨íŠ¸
function renderTypeChart(data) {
  const typeCount = { elevatorNo: 0, address: 0 };
  data.forEach(d => typeCount[d.type]++);

  new Chart(document.getElementById("typeChart"), {
    type: "pie",
    data: {
      labels: ["ìŠ¹ë²ˆ ê²€ìƒ‰", "ì£¼ì†Œ ê²€ìƒ‰"],
      datasets: [{
        data: [typeCount.elevatorNo, typeCount.address],
        backgroundColor: ["#6e22ff", "#d67cff"]
      }]
    }
  });
}

// ë§ì´ ê²€ìƒ‰ëœ ìŠ¹ë²ˆ Top 10
function renderTopList(data) {
  const count = {};
  data.forEach(d => {
    if (d.type === "elevatorNo")
      count[d.query] = (count[d.query] || 0) + 1;
  });

  const sorted = Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,10);

  document.getElementById("topList").innerHTML = sorted
    .map(([num, cnt]) => `<li>${num} â€” ${cnt}íšŒ</li>`)
    .join("");
}
</script>

</body>
</html>
